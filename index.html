<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Jornada</title>
    <base href="/Jornada/">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#28a745"/>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="JornadaGPS">
    <style>
        :root{
            --main-bg-color:#f4f7f6;
            --card-bg-color:#fff;
            --primary-color:#007bff;
            --secondary-color:#6c757d;
            --success-color:#28a745;
            --danger-color:#dc3545;
            --text-color:#333;
            --border-color:#e0e0e0
        }
        *{box-sizing:border-box}
        body{
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
            margin:0;
            padding:10px;
            background-color:var(--main-bg-color);
            color:var(--text-color);
            line-height:1.6
        }
        .container{max-width:600px;margin:0 auto}
        .vista{
            background:var(--card-bg-color);
            padding:20px;
            border-radius:12px;
            box-shadow:0 4px 12px rgba(0,0,0,.1);
            margin-bottom:20px
        }
        h2{
            text-align:center;
            border-bottom:2px solid var(--border-color);
            padding-bottom:15px;
            margin-top:0;
            color:var(--text-color)
        }
        button{
            display:block;
            width:100%;
            padding:16px;
            font-size:18px;
            font-weight:700;
            color:#fff;
            border:none;
            border-radius:8px;
            cursor:pointer;
            margin-top:15px;
            transition:all .3s ease;
            text-align:center
        }
        button:hover:not(:disabled){
            transform:translateY(-2px);
            box-shadow:0 4px 8px rgba(0,0,0,.15)
        }
        button:disabled{
            opacity:.6;
            cursor:not-allowed;
            transform:none
        }
        .btn-confirm{background-color:var(--success-color)}
        .btn-cancel{background-color:var(--danger-color)}
        label{
            display:block;
            margin-bottom:5px;
            font-weight:700;
            color:var(--text-color)
        }
        input,select{
            width:100%;
            padding:14px;
            margin-bottom:15px;
            border-radius:8px;
            border:2px solid var(--border-color);
            font-size:16px;
            background-color:#fcfcfc;
            transition:border-color .3s ease;
            font-family:inherit;
            -webkit-appearance:none
        }
        input:focus,select:focus{
            outline:0;
            border-color:var(--primary-color)
        }
        .status-message{
            position:fixed;
            top:50%;
            left:50%;
            transform:translate(-50%,-50%);
            z-index:3000;
            max-width:90%;
            width:auto;
            min-width:320px;
            text-align:center;
            font-weight:700;
            padding:20px 25px;
            border-radius:12px;
            box-shadow:0 8px 25px rgba(0,0,0,.3);
            transition:all .3s ease;
            backdrop-filter:blur(5px)
        }
        .status-success{
            background-color:rgba(212,237,218,.95);
            color:#155724;
            border:2px solid #c3e6cb
        }
        .status-error{
            background-color:rgba(248,215,218,.95);
            color:#721c24;
            border:2px solid #f5c6cb
        }
        .status-loading{
            background-color:rgba(209,236,241,.95);
            color:#0c5460;
            border:2px solid #bee5eb
        }
        .gps-indicator{
            position:fixed;
            top:10px;
            right:10px;
            width:20px;
            height:20px;
            border-radius:50%;
            background-color:#dc3545;
            z-index:1000;
            animation:pulse 2s infinite;
            cursor:pointer
        }
        .gps-active{background-color:#28a745}
        .debug-info{
            position:fixed;
            bottom:10px;
            left:10px;
            background:rgba(0,0,0,0.8);
            color:white;
            padding:5px 10px;
            border-radius:5px;
            font-size:12px;
            max-width:300px;
            z-index:2000;
            max-height:100px;
            overflow-y:auto
        }
        .loading-spinner{
            display:inline-block;
            width:20px;
            height:20px;
            border:3px solid #f3f3f3;
            border-top:3px solid #3498db;
            border-radius:50%;
            animation:spin 1s linear infinite;
            margin-right:10px
        }
        @keyframes spin{
            0%{transform:rotate(0)}
            100%{transform:rotate(360deg)}
        }
        @keyframes pulse{
            0%{opacity:1}
            50%{opacity:0.5}
            100%{opacity:1}
        }
        .hidden{display:none!important}
        .keepalive-frame{
            position:fixed;
            left:-1px;
            top:-1px;
            width:1px;
            height:1px;
            opacity:0;
            pointer-events:none
        }
    </style>
</head>
<body>
    <div class="gps-indicator" id="gps-indicator" title="Estado GPS"></div>
    <div class="debug-info" id="debug-info">Esperando...</div>
    <iframe class="keepalive-frame" id="keepalive-frame" src="about:blank"></iframe>
    
    <div class="container">
        <div class="vista">
            <h2>‚òÄÔ∏èüåô Registro de Jornada</h2>
            <label for="nombre-usuario">Tu Nombre:</label>
            <select id="nombre-usuario" required>
                <option value="">-- Cargando usuarios... --</option>
            </select>
            <label for="vehiculo">Veh√≠culo:</label>
            <input type="text" id="vehiculo" placeholder="Selecciona tu nombre o escribe" required>
            <label for="kilometraje">Kilometraje:</label>
            <input type="text" inputmode="numeric" pattern="[0-9]*" id="kilometraje" placeholder="Ej: 121205" required>
            <button type="button" id="btn-iniciar-jornada" class="btn-confirm" disabled>‚ñ∂Ô∏è Iniciar Jornada y GPS</button>
            <button type="button" id="btn-finalizar-jornada" class="btn-cancel" disabled>‚èπÔ∏è Finalizar Jornada y GPS</button>
        </div>
    </div>
    <div class="status-message hidden" id="status-message"></div>
    
    <script>
        class SistemaJornada {
            constructor() {
                this.SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzTMbUM3OZNnozxj_g8OONJG4zIubpSoHGA59GbliTlUwU0EJAoOSNuyUGhX5FDfsCC/exec";
                this.estado = { 
                    procesando: false, 
                    usuarios: [], 
                    serviceWorkerReady: false, 
                    gpsActivo: false,
                    wakeLock: null,
                    heartbeatInterval: null,
                    gpsInterval: null,
                    keepAliveInterval: null,
                    ubicacionesProcesadas: 0,
                    ultimaUbicacion: null,
                    modoSegundoPlano: false
                };
                this.inicializar();
            }

            actualizarDebugInfo(mensaje) {
                const debugDiv = document.getElementById('debug-info');
                const timestamp = new Date().toLocaleTimeString();
                debugDiv.innerHTML += `<div>${timestamp}: ${mensaje}</div>`;
                debugDiv.scrollTop = debugDiv.scrollHeight;
                console.log(`[DEBUG] ${mensaje}`);
            }

            async inicializar() {
                this.actualizarDebugInfo("Inicializando sistema...");
                this.bindearEventos();
                await this.cargarUsuarios();
                this.registrarServiceWorker();
                this.configurarEscuchaServiceWorker();
                this.configurarMantenimientoAgresivo();
                this.configurarIndicadorGPS();
                this.configurarDeteccionSegundoPlano();
                this.actualizarDebugInfo("Sistema listo");
            }

            // NUEVA: Configurar detecci√≥n y manejo de segundo plano
            configurarDeteccionSegundoPlano() {
                // Detectar cuando la p√°gina pasa a segundo plano
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && this.estado.gpsActivo) {
                        this.actualizarDebugInfo("üôà P√ÅGINA OCULTA - Activando modo supervivencia");
                        this.estado.modoSegundoPlano = true;
                        this.activarModoSupervivencia();
                    } else if (!document.hidden && this.estado.gpsActivo) {
                        this.actualizarDebugInfo("üëÅÔ∏è P√ÅGINA VISIBLE - Desactivando modo supervivencia");
                        this.estado.modoSegundoPlano = false;
                        this.desactivarModoSupervivencia();
                    }
                });

                // Detectar cuando la app pierde el foco
                window.addEventListener('blur', () => {
                    if (this.estado.gpsActivo) {
                        this.actualizarDebugInfo("üîÑ App perdi√≥ foco - Activando supervivencia");
                        this.activarModoSupervivencia();
                    }
                });

                window.addEventListener('focus', () => {
                    if (this.estado.gpsActivo) {
                        this.actualizarDebugInfo("üéØ App recuper√≥ foco - Sincronizando");
                        this.sincronizarEstado();
                    }
                });
            }

            // NUEVA: Modo supervivencia para segundo plano
            activarModoSupervivencia() {
                // 1. Activar GPS directo en la p√°gina (fallback)
                if (!this.estado.gpsInterval) {
                    this.estado.gpsInterval = setInterval(() => {
                        this.procesarGPSDirecto();
                    }, 60000); // Cada minuto
                    this.actualizarDebugInfo("üõ°Ô∏è GPS directo activado");
                }

                // 2. Keep-alive m√°s agresivo
                this.activarKeepAliveAgresivo();

                // 3. Asegurar Wake Lock
                this.asegurarWakeLock();
            }

            desactivarModoSupervivencia() {
                // Limpiar GPS directo
                if (this.estado.gpsInterval) {
                    clearInterval(this.estado.gpsInterval);
                    this.estado.gpsInterval = null;
                    this.actualizarDebugInfo("üõ°Ô∏è GPS directo desactivado");
                }
            }

            // NUEVA: GPS directo como fallback
            async procesarGPSDirecto() {
                try {
                    this.actualizarDebugInfo("üìç GPS DIRECTO - Obteniendo ubicaci√≥n...");
                    const ubicacionTexto = await this.obtenerUbicacion();
                    const [lat, lon] = ubicacionTexto.split(', ').map(s => parseFloat(s.trim()));
                    
                    // Enviar directamente al servidor
                    await fetch(this.SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            accion: 'registrar_gps',
                            usuario: document.getElementById('nombre-usuario').value,
                            lat: lat,
                            lon: lon,
                            timestamp: Date.now(),
                            modo: 'directo',
                            segundo_plano: this.estado.modoSegundoPlano
                        })
                    });
                    
                    this.estado.ubicacionesProcesadas++;
                    this.actualizarDebugInfo(`‚úÖ GPS DIRECTO #${this.estado.ubicacionesProcesadas} enviado`);
                    this.actualizarIndicadorGPS(true);
                    
                } catch (error) {
                    this.actualizarDebugInfo(`‚ùå GPS DIRECTO fall√≥: ${error.message}`);
                }
            }

            // NUEVA: Keep-alive agresivo
            activarKeepAliveAgresivo() {
                // 1. Audio silencioso para mantener activo
                this.reproducirAudioSilencioso();
                
                // 2. Keep-alive con fetch a un endpoint dummy
                if (!this.estado.keepAliveInterval) {
                    this.estado.keepAliveInterval = setInterval(() => {
                        // Fetch a una URL dummy para mantener la conexi√≥n
                        fetch('data:text/plain,keepalive', { method: 'HEAD' }).catch(() => {});
                        this.actualizarDebugInfo("üíì Keep-alive");
                    }, 30000);
                }

                // 3. Manipulaci√≥n DOM m√≠nima para mantener activo
                setInterval(() => {
                    document.title = document.title; // Refresco m√≠nimo
                }, 45000);
            }

            // NUEVA: Audio silencioso
            reproducirAudioSilencioso() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(20, audioContext.currentTime); // 20Hz - inaudible
                    gainNode.gain.setValueAtTime(0.001, audioContext.currentTime); // Volumen m√≠nimo
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.1);
                    
                    this.actualizarDebugInfo("üîä Audio keep-alive activado");
                } catch (error) {
                    this.actualizarDebugInfo("üîá Audio keep-alive no disponible");
                }
            }

            // NUEVA: Asegurar Wake Lock
            async asegurarWakeLock() {
                if ('wakeLock' in navigator && !this.estado.wakeLock) {
                    try {
                        this.estado.wakeLock = await navigator.wakeLock.request('screen');
                        this.actualizarDebugInfo("üîí Wake Lock asegurado");
                        
                        this.estado.wakeLock.addEventListener('release', () => {
                            this.actualizarDebugInfo("üîì Wake Lock liberado");
                            this.estado.wakeLock = null;
                            // Reintentarlo
                            setTimeout(() => this.asegurarWakeLock(), 1000);
                        });
                    } catch (error) {
                        this.actualizarDebugInfo("‚ùå Wake Lock fall√≥");
                    }
                }
            }

            configurarIndicadorGPS() {
                const indicator = document.getElementById('gps-indicator');
                indicator.addEventListener('click', () => {
                    if (this.estado.gpsActivo) {
                        this.mostrarMensaje(`GPS activo - ${this.estado.ubicacionesProcesadas} ubicaciones enviadas`, 'success');
                    } else {
                        this.mostrarMensaje('GPS inactivo', 'error');
                    }
                });
            }

            async configurarMantenimientoAgresivo() {
                this.configurarHeartbeat();
                this.configurarWebLock();
            }

            configurarHeartbeat() {
                this.estado.heartbeatInterval = setInterval(() => {
                    if (this.estado.gpsActivo && navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({
                            action: 'heartbeat',
                            timestamp: Date.now(),
                            ubicacionesProcesadas: this.estado.ubicacionesProcesadas,
                            modoSegundoPlano: this.estado.modoSegundoPlano
                        });
                    }
                }, 10000); // Cada 10 segundos
            }

            async configurarWebLock() {
                if ('locks' in navigator) {
                    const manteneerLock = async () => {
                        if (this.estado.gpsActivo) {
                            try {
                                await navigator.locks.request('gps-tracking', { mode: 'exclusive' }, async (lock) => {
                                    this.actualizarDebugInfo("üîê Web Lock adquirido");
                                    while (this.estado.gpsActivo) {
                                        await new Promise(resolve => setTimeout(resolve, 5000));
                                        // Mini keep-alive dentro del lock
                                        navigator.locks.query().catch(() => {});
                                    }
                                    this.actualizarDebugInfo("üîì Web Lock liberado");
                                });
                            } catch (err) {
                                this.actualizarDebugInfo("‚ùå Error con Web Lock");
                            }
                        }
                    };
                    document.addEventListener('gps-started', manteneerLock);
                }
            }

            bindearEventos() {
                document.getElementById('btn-iniciar-jornada').addEventListener('click', () => this.registrarEvento('Inicio de Jornada'));
                document.getElementById('btn-finalizar-jornada').addEventListener('click', () => this.registrarEvento('Fin de Jornada'));
                document.getElementById('nombre-usuario').addEventListener('change', (e) => this.actualizarVehiculo(e.target.value));
            }

            configurarEscuchaServiceWorker() {
                if (this.serviceWorkerMessageHandler) {
                    navigator.serviceWorker.removeEventListener('message', this.serviceWorkerMessageHandler);
                }

                this.serviceWorkerMessageHandler = (event) => {
                    if (event.data.action === 'requestLocation') {
                        this.obtenerUbicacionParaSW();
                    } else if (event.data.action === 'gpsStatus') {
                        this.actualizarIndicadorGPS(event.data.active);
                        if (event.data.lastSent) {
                            this.estado.ubicacionesProcesadas++;
                            this.actualizarDebugInfo(`SW: Ubicaci√≥n ${this.estado.ubicacionesProcesadas} enviada`);
                        }
                    } else if (event.data.action === 'ping') {
                        navigator.serviceWorker.controller?.postMessage({
                            action: 'pong',
                            timestamp: Date.now()
                        });
                    }
                };

                navigator.serviceWorker.addEventListener('message', this.serviceWorkerMessageHandler);
            }

            actualizarIndicadorGPS(activo) {
                const indicator = document.getElementById('gps-indicator');
                if (activo) {
                    indicator.classList.add('gps-active');
                    indicator.title = `GPS Activo - ${this.estado.ubicacionesProcesadas} enviadas`;
                } else {
                    indicator.classList.remove('gps-active');
                    indicator.title = 'GPS Inactivo';
                }
            }

            async obtenerUbicacionParaSW() {
                try {
                    this.actualizarDebugInfo("üìç SW solicita GPS...");
                    const ubicacionTexto = await this.obtenerUbicacion();
                    const [lat, lon] = ubicacionTexto.split(', ').map(s => parseFloat(s.trim()));
                    
                    this.estado.ultimaUbicacion = { lat, lon, timestamp: Date.now() };
                    
                    if (!navigator.serviceWorker.controller) {
                        this.actualizarDebugInfo("‚ùå SW perdido - usando GPS directo");
                        this.procesarGPSDirecto();
                        return;
                    }
                    
                    navigator.serviceWorker.controller.postMessage({
                        action: 'locationResponse',
                        lat: lat,
                        lon: lon,
                        timestamp: Date.now()
                    });
                    
                    this.actualizarDebugInfo(`üì§ GPS enviado al SW: ${lat.toFixed(4)}, ${lon.toFixed(4)}`);
                    
                } catch (error) {
                    this.actualizarDebugInfo(`‚ùå Error GPS: ${error.message}`);
                    navigator.serviceWorker.controller?.postMessage({
                        action: 'locationError',
                        error: error.message
                    });
                }
            }

            sincronizarEstado() {
                // Sincronizar estado cuando la app vuelve al primer plano
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        action: 'syncState',
                        ubicacionesProcesadas: this.estado.ubicacionesProcesadas,
                        timestamp: Date.now()
                    });
                }
            }

            // ... resto de m√©todos igual que antes ...

            async cargarUsuarios() {
                try {
                    const select = document.getElementById('nombre-usuario');
                    const usuarios = await this.enviarDatosGET({ accion: 'obtener_usuarios' });
                    this.usuarios = usuarios;
                    select.innerHTML = '<option value="">-- Selecciona tu nombre --</option>';
                    usuarios.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.nombre;
                        option.textContent = user.nombre;
                        select.appendChild(option);
                    });
                    this.actualizarDebugInfo(`${usuarios.length} usuarios cargados`);
                } catch (error) { 
                    this.mostrarMensaje('Error al cargar usuarios', 'error'); 
                    this.enviarErrorAlServidor(error); 
                }
            }

            actualizarVehiculo(nombreSeleccionado) {
                const vehiculoInput = document.getElementById('vehiculo');
                const usuario = this.usuarios.find(user => user.nombre === nombreSeleccionado);
                vehiculoInput.value = usuario ? usuario.vehiculo : '';
            }

            validarFormulario() {
                const nombre = document.getElementById('nombre-usuario').value;
                const vehiculo = document.getElementById('vehiculo').value.trim();
                const km = document.getElementById('kilometraje').value.trim();
                if (!nombre || !vehiculo || !km) {
                    this.mostrarMensaje('Completa todos los campos', 'error');
                    return null;
                }
                return { nombre, vehiculo, kilometraje: km };
            }

            async registrarEvento(tipoEvento) {
                if (this.estado.procesando) return;
                if (!this.estado.serviceWorkerReady) {
                    this.mostrarMensaje('La app no est√° lista. Por favor, recarga la p√°gina.', 'error');
                    return;
                }
                const datos = this.validarFormulario();
                if (!datos) return;
                
                this.estado.procesando = true;
                const btn = (tipoEvento === 'Inicio de Jornada') ? 
                    document.getElementById('btn-iniciar-jornada') : 
                    document.getElementById('btn-finalizar-jornada');
                btn.disabled = true;
                this.mostrarMensaje('Obteniendo ubicaci√≥n...', 'loading');
                
                try {
                    const ubicacion = await this.obtenerUbicacion();
                    const payload = { 
                        accion: 'registrar_jornada', 
                        tipo_evento: tipoEvento, 
                        ubicacion: ubicacion, 
                        ...datos 
                    };
                    await this.enviarDatosPOST(payload);
                    this.mostrarMensaje(`‚úÖ ${tipoEvento} registrado.`, 'success');
                    document.getElementById('kilometraje').value = '';
                    
                    if (tipoEvento === 'Inicio de Jornada') {
                        this.iniciarSeguimiento();
                    } else {
                        this.detenerSeguimiento();
                    }
                } catch (error) {
                    this.mostrarMensaje(`Error: ${error.message}`, 'error');
                    this.enviarErrorAlServidor(error);
                } finally {
                    setTimeout(() => {
                        this.estado.procesando = false;
                        btn.disabled = false;
                        this.limpiarMensaje();
                    }, 3000);
                }
            }
            
            iniciarSeguimiento() {
                this.actualizarDebugInfo("üöÄ Iniciando GPS tracking...");
                const usuario = document.getElementById('nombre-usuario').value;
                this.estado.gpsActivo = true;
                this.estado.ubicacionesProcesadas = 0;
                
                document.dispatchEvent(new CustomEvent('gps-started'));
                
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        action: 'startGps',
                        usuario: usuario,
                        url: this.SCRIPT_URL,
                        intervalo: 60000
                    });
                }
                
                // Activar modo supervivencia inmediatamente
                setTimeout(() => this.activarModoSupervivencia(), 2000);
                
                this.actualizarIndicadorGPS(true);
                this.mostrarMensaje('üõ∞Ô∏è GPS activado - Supervivencia activada', 'success');
                this.actualizarDebugInfo("‚úÖ GPS activado con supervivencia");
            }

            detenerSeguimiento() {
                this.actualizarDebugInfo("üõë Deteniendo GPS...");
                this.estado.gpsActivo = false;
                
                this.desactivarModoSupervivencia();
                
                if (this.estado.wakeLock) {
                    this.estado.wakeLock.release();
                    this.estado.wakeLock = null;
                }
                
                if (this.estado.keepAliveInterval) {
                    clearInterval(this.estado.keepAliveInterval);
                    this.estado.keepAliveInterval = null;
                }
                
                navigator.serviceWorker.controller?.postMessage({ action: 'stopGps' });
                this.actualizarIndicadorGPS(false);
                this.mostrarMensaje('‚èπÔ∏è GPS detenido', 'success');
                this.actualizarDebugInfo("‚úÖ GPS detenido");
            }
            
            registrarServiceWorker() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/Jornada/sw.js', {
                        scope: '/Jornada/'
                    })
                        .then((registration) => {
                            this.actualizarDebugInfo("SW registrado");
                            return navigator.serviceWorker.ready;
                        })
                        .then(() => {
                            if (navigator.serviceWorker.controller) {
                                this.actualizarDebugInfo("SW controlando p√°gina");
                                this.estado.serviceWorkerReady = true;
                                document.getElementById('btn-iniciar-jornada').disabled = false;
                                document.getElementById('btn-finalizar-jornada').disabled = false;
                            } else {
                                this.actualizarDebugInfo("SW no activo, recargando...");
                                window.location.reload();
                            }
                        })
                        .catch(error => {
                            this.actualizarDebugInfo("Error SW: " + error.message);
                            this.mostrarMensaje('Error cr√≠tico: No se pudo activar el servicio de fondo.', 'error');
                            this.enviarErrorAlServidor(error);
                        });
                } else {
                    this.mostrarMensaje('El seguimiento en segundo plano no es compatible.', 'error');
                }
            }
            
            obtenerUbicacion() { 
                return new Promise((resolve, reject) => { 
                    if (!navigator.geolocation) return reject(new Error("Geolocalizaci√≥n no soportada")); 
                    navigator.geolocation.getCurrentPosition( 
                        pos => resolve(`${pos.coords.latitude}, ${pos.coords.longitude}`), 
                        err => reject(new Error(err.message)), 
                        { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
                    ); 
                }); 
            }
            
            async enviarErrorAlServidor(error) { 
                try { 
                    const usuario = document.getElementById('nombre-usuario').value || 'No definido'; 
                    const payload = { 
                        accion: 'registrar_error', 
                        usuario: usuario, 
                        error: error.message || JSON.stringify(error) 
                    }; 
                    await fetch(this.SCRIPT_URL, { 
                        method: 'POST', 
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                        body: JSON.stringify(payload) 
                    }); 
                } catch (e) { 
                    console.error("Fallo al enviar el error:", e); 
                } 
            }
            
            async enviarDatosPOST(payload) { 
                try { 
                    await fetch(this.SCRIPT_URL, { 
                        method: 'POST', 
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                        body: JSON.stringify(payload) 
                    }); 
                } catch (e) { 
                    throw new Error('Error de conexi√≥n.'); 
                } 
            }
            
            async enviarDatosGET(payload) { 
                return new Promise((resolve, reject) => { 
                    const cb = 'c' + Date.now(); 
                    const s = document.createElement('script'); 
                    const t = setTimeout(() => { 
                        delete window[cb]; 
                        if (s.parentNode) s.remove(); 
                        reject(new Error('Timeout')); 
                    }, 20000); 
                    window[cb] = (r) => { 
                        clearTimeout(t); 
                        delete window[cb]; 
                        if (s.parentNode) s.remove(); 
                        if (r.status === 'success') { 
                            resolve(r.data); 
                        } else { 
                            reject(new Error(r.message)); 
                        } 
                    }; 
                    const u = new URL(this.SCRIPT_URL); 
                    u.searchParams.append('data', JSON.stringify(payload)); 
                    u.searchParams.append('callback', cb); 
                    s.src = u.href; 
                    s.onerror = () => { 
                        clearTimeout(t); 
                        delete window[cb]; 
                        if (s.parentNode) s.remove(); 
                        reject(new Error('Error de red.')); 
                    }; 
                    document.body.appendChild(s); 
                }); 
            }
            
            mostrarMensaje(msg, tipo) { 
                const div = document.getElementById('status-message'); 
                div.textContent = msg; 
                div.className = `status-message status-${tipo}`; 
                div.classList.remove('hidden'); 
            }
            
            limpiarMensaje() { 
                const div = document.getElementById('status-message'); 
                if (div) { 
                    div.className = 'status-message hidden'; 
                } 
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => { 
            new SistemaJornada(); 
        });
    </script>
</body>
</html>
