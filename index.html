<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Jornada</title>
    <base href="/Jornada/">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#28a745"/>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <style>
        *{box-sizing:border-box}
        body{
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
            margin:0;
            padding:20px;
            background-color:#f4f7f6;
            color:#333;
            line-height:1.6
        }
        .container{max-width:500px;margin:0 auto}
        .card{
            background:#fff;
            padding:25px;
            border-radius:12px;
            box-shadow:0 4px 12px rgba(0,0,0,.1);
            margin-bottom:20px
        }
        h1{
            text-align:center;
            margin-top:0;
            color:#28a745;
            border-bottom:2px solid #e0e0e0;
            padding-bottom:15px
        }
        label{
            display:block;
            margin-bottom:8px;
            font-weight:600;
            color:#333
        }
        input,select{
            width:100%;
            padding:15px;
            margin-bottom:20px;
            border-radius:8px;
            border:2px solid #e0e0e0;
            font-size:16px;
            font-family:inherit
        }
        input:focus,select:focus{
            outline:0;
            border-color:#28a745
        }
        button{
            display:block;
            width:100%;
            padding:18px;
            font-size:18px;
            font-weight:700;
            color:#fff;
            border:none;
            border-radius:8px;
            cursor:pointer;
            margin-bottom:15px;
            transition:all .3s ease
        }
        button:disabled{
            opacity:.6;
            cursor:not-allowed
        }
        .btn-start{background-color:#28a745}
        .btn-end{background-color:#dc3545}
        .btn-start:hover:not(:disabled){background-color:#218838}
        .btn-end:hover:not(:disabled){background-color:#c82333}
        .status{
            position:fixed;
            top:20px;
            left:50%;
            transform:translateX(-50%);
            background:#fff;
            padding:15px 25px;
            border-radius:25px;
            box-shadow:0 4px 15px rgba(0,0,0,.2);
            z-index:1000;
            font-weight:600
        }
        .status.active{
            background:#28a745;
            color:#fff
        }
        .gps-count{
            position:fixed;
            top:20px;
            right:20px;
            background:rgba(0,0,0,.8);
            color:#fff;
            padding:8px 12px;
            border-radius:20px;
            font-size:12px;
            z-index:1000
        }
        .message{
            position:fixed;
            top:50%;
            left:50%;
            transform:translate(-50%,-50%);
            background:#fff;
            padding:20px 30px;
            border-radius:12px;
            box-shadow:0 8px 25px rgba(0,0,0,.3);
            z-index:2000;
            text-align:center;
            font-weight:600;
            max-width:90%;
            display:none
        }
        .message.show{display:block}
        .message.success{border-left:5px solid #28a745}
        .message.error{border-left:5px solid #dc3545}
        .message.loading{border-left:5px solid #007bff}
        .info{
            background:#e3f2fd;
            border:1px solid #90caf9;
            color:#1976d2;
            padding:15px;
            border-radius:8px;
            margin-bottom:20px;
            font-size:14px
        }
    </style>
</head>
<body>
    <div class="status" id="status">GPS Inactivo</div>
    <div class="gps-count" id="gps-count">Ubicaciones: 0</div>
    
    <div class="container">
        <div class="card">
            <h1>üöõ Registro de Jornada</h1>
            
            <div class="info">
                üìç <strong>Instrucciones:</strong><br>
                1. Selecciona tu nombre y veh√≠culo<br>
                2. Ingresa el kilometraje inicial<br>
                3. Presiona "Iniciar Jornada" (activar√° GPS autom√°tico)<br>
                4. Al terminar, ingresa kilometraje final y presiona "Finalizar"
            </div>

            <label for="nombre">Chofer:</label>
            <select id="nombre" required>
                <option value="">-- Selecciona tu nombre --</option>
            </select>

            <label for="vehiculo">Veh√≠culo:</label>
            <input type="text" id="vehiculo" placeholder="Veh√≠culo asignado" required>

            <label for="kilometraje">Kilometraje:</label>
            <input type="number" id="kilometraje" placeholder="Ej: 125000" required>

            <button type="button" id="btn-iniciar" class="btn-start" disabled>
                ‚ñ∂Ô∏è Iniciar Jornada y GPS
            </button>
            
            <button type="button" id="btn-finalizar" class="btn-end" disabled>
                ‚èπÔ∏è Finalizar Jornada
            </button>
        </div>
    </div>
    
    <div class="message" id="message"></div>
    
    <script>
        class JornadaSimple {
            constructor() {
                this.SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzTMbUM3OZNnozxj_g8OONJG4zIubpSoHGA59GbliTlUwU0EJAoOSNuyUGhX5FDfsCC/exec";
                this.estado = {
                    jornadaActiva: false,
                    swReady: false,
                    gpsCount: 0,
                    usuarios: [],
                    gpsInterval: null,
                    ultimaUbicacion: null
                };
                this.init();
            }

            async init() {
                await this.cargarUsuarios();
                this.setupEventos();
                this.registrarSW();
                this.configurarGPS();
            }

            async cargarUsuarios() {
                try {
                    const usuarios = await this.fetchGET({ accion: 'obtener_usuarios' });
                    this.estado.usuarios = usuarios;
                    const select = document.getElementById('nombre');
                    select.innerHTML = '<option value="">-- Selecciona tu nombre --</option>';
                    usuarios.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.nombre;
                        option.textContent = user.nombre;
                        select.appendChild(option);
                    });
                } catch (error) {
                    this.mostrarMensaje('Error cargando usuarios', 'error');
                }
            }

            setupEventos() {
                document.getElementById('nombre').addEventListener('change', (e) => {
                    const usuario = this.estado.usuarios.find(u => u.nombre === e.target.value);
                    document.getElementById('vehiculo').value = usuario ? usuario.vehiculo : '';
                });

                document.getElementById('btn-iniciar').addEventListener('click', () => this.iniciarJornada());
                document.getElementById('btn-finalizar').addEventListener('click', () => this.finalizarJornada());
            }

            registrarSW() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/Jornada/sw.js', { scope: '/Jornada/' })
                        .then(() => navigator.serviceWorker.ready)
                        .then(() => {
                            if (navigator.serviceWorker.controller) {
                                this.estado.swReady = true;
                                document.getElementById('btn-iniciar').disabled = false;
                                this.actualizarStatus('GPS Listo');
                            } else {
                                window.location.reload();
                            }
                        })
                        .catch(() => {
                            this.mostrarMensaje('Error activando GPS autom√°tico', 'error');
                        });
                } else {
                    this.mostrarMensaje('GPS autom√°tico no compatible', 'error');
                }
            }

            configurarGPS() {
                navigator.serviceWorker?.addEventListener('message', (event) => {
                    if (event.data.action === 'requestLocation') {
                        this.procesarUbicacion();
                    } else if (event.data.action === 'ubicacionEnviada') {
                        this.estado.gpsCount++;
                        this.actualizarContador();
                    }
                });

                // GPS directo como respaldo
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden && this.estado.jornadaActiva) {
                        // Al volver a la app, enviar ubicaci√≥n inmediata
                        setTimeout(() => this.procesarUbicacion(), 1000);
                    }
                });
            }

            async procesarUbicacion() {
                if (!this.estado.jornadaActiva) return;

                try {
                    const posicion = await this.obtenerGPS();
                    const ubicacion = {
                        lat: posicion.coords.latitude,
                        lon: posicion.coords.longitude,
                        timestamp: Date.now(),
                        accuracy: posicion.coords.accuracy
                    };

                    // Evitar duplicados (mismo lugar en menos de 30 segundos)
                    if (this.estado.ultimaUbicacion) {
                        const tiempoDiff = ubicacion.timestamp - this.estado.ultimaUbicacion.timestamp;
                        const distancia = this.calcularDistancia(
                            this.estado.ultimaUbicacion.lat, this.estado.ultimaUbicacion.lon,
                            ubicacion.lat, ubicacion.lon
                        );
                        
                        if (tiempoDiff < 30000 && distancia < 0.01) { // Menos de 30 seg y 10 metros
                            return; // No enviar ubicaci√≥n duplicada
                        }
                    }

                    await this.enviarUbicacion(ubicacion);
                    this.estado.ultimaUbicacion = ubicacion;
                    this.estado.gpsCount++;
                    this.actualizarContador();

                } catch (error) {
                    console.log('Error GPS:', error.message);
                }
            }

            async enviarUbicacion(ubicacion) {
                const payload = {
                    accion: 'registrar_gps',
                    usuario: document.getElementById('nombre').value,
                    lat: ubicacion.lat,
                    lon: ubicacion.lon,
                    timestamp: ubicacion.timestamp,
                    accuracy: ubicacion.accuracy,
                    secuencia: this.estado.gpsCount + 1
                };

                await this.fetchPOST(payload);

                // Notificar al SW si est√° disponible
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        action: 'ubicacionEnviada',
                        secuencia: this.estado.gpsCount + 1
                    });
                }
            }

            calcularDistancia(lat1, lon1, lat2, lon2) {
                const R = 6371; // Radio de la Tierra en km
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                         Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                         Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            async iniciarJornada() {
                if (!this.validarFormulario()) return;

                try {
                    this.mostrarMensaje('Obteniendo ubicaci√≥n inicial...', 'loading');
                    
                    const posicion = await this.obtenerGPS();
                    const ubicacion = `${posicion.coords.latitude}, ${posicion.coords.longitude}`;
                    
                    const payload = {
                        accion: 'registrar_jornada',
                        tipo_evento: 'Inicio de Jornada',
                        nombre: document.getElementById('nombre').value,
                        vehiculo: document.getElementById('vehiculo').value,
                        kilometraje: document.getElementById('kilometraje').value,
                        ubicacion: ubicacion
                    };

                    await this.fetchPOST(payload);
                    
                    // Activar GPS autom√°tico
                    this.estado.jornadaActiva = true;
                    this.estado.gpsCount = 0;
                    this.iniciarGPSAutomatico();
                    
                    // UI
                    document.getElementById('btn-iniciar').disabled = true;
                    document.getElementById('btn-finalizar').disabled = false;
                    document.getElementById('kilometraje').value = '';
                    document.getElementById('kilometraje').placeholder = 'Kilometraje final';
                    
                    this.actualizarStatus('Jornada Activa');
                    this.actualizarContador();
                    this.mostrarMensaje('‚úÖ Jornada iniciada - GPS activado', 'success');
                    
                } catch (error) {
                    this.mostrarMensaje('Error: ' + error.message, 'error');
                }
            }

            async finalizarJornada() {
                if (!document.getElementById('kilometraje').value) {
                    this.mostrarMensaje('Ingresa el kilometraje final', 'error');
                    return;
                }

                try {
                    this.mostrarMensaje('Finalizando jornada...', 'loading');
                    
                    const posicion = await this.obtenerGPS();
                    const ubicacion = `${posicion.coords.latitude}, ${posicion.coords.longitude}`;
                    
                    const payload = {
                        accion: 'registrar_jornada',
                        tipo_evento: 'Fin de Jornada',
                        nombre: document.getElementById('nombre').value,
                        vehiculo: document.getElementById('vehiculo').value,
                        kilometraje: document.getElementById('kilometraje').value,
                        ubicacion: ubicacion,
                        total_ubicaciones_gps: this.estado.gpsCount
                    };

                    await this.fetchPOST(payload);
                    
                    // Detener GPS
                    this.estado.jornadaActiva = false;
                    this.detenerGPSAutomatico();
                    
                    // UI
                    document.getElementById('btn-iniciar').disabled = false;
                    document.getElementById('btn-finalizar').disabled = true;
                    document.getElementById('kilometraje').value = '';
                    document.getElementById('kilometraje').placeholder = 'Kilometraje inicial';
                    
                    this.actualizarStatus('GPS Listo');
                    this.mostrarMensaje(`‚úÖ Jornada finalizada - ${this.estado.gpsCount} ubicaciones registradas`, 'success');
                    
                } catch (error) {
                    this.mostrarMensaje('Error: ' + error.message, 'error');
                }
            }

            iniciarGPSAutomatico() {
                // Service Worker GPS
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        action: 'startGps',
                        usuario: document.getElementById('nombre').value,
                        url: this.SCRIPT_URL,
                        intervalo: 60000 // 1 minuto
                    });
                }

                // GPS directo como respaldo
                this.estado.gpsInterval = setInterval(() => {
                    if (this.estado.jornadaActiva) {
                        this.procesarUbicacion();
                    }
                }, 60000); // 1 minuto
            }

            detenerGPSAutomatico() {
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ action: 'stopGps' });
                }
                
                if (this.estado.gpsInterval) {
                    clearInterval(this.estado.gpsInterval);
                    this.estado.gpsInterval = null;
                }
            }

            validarFormulario() {
                const nombre = document.getElementById('nombre').value;
                const vehiculo = document.getElementById('vehiculo').value;
                const km = document.getElementById('kilometraje').value;
                
                if (!nombre || !vehiculo || !km) {
                    this.mostrarMensaje('Completa todos los campos', 'error');
                    return false;
                }
                return true;
            }

            actualizarStatus(texto) {
                const status = document.getElementById('status');
                status.textContent = texto;
                status.className = this.estado.jornadaActiva ? 'status active' : 'status';
            }

            actualizarContador() {
                document.getElementById('gps-count').textContent = `Ubicaciones: ${this.estado.gpsCount}`;
            }

            obtenerGPS() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('GPS no disponible'));
                        return;
                    }
                    
                    navigator.geolocation.getCurrentPosition(
                        resolve,
                        (error) => reject(new Error('Error obteniendo ubicaci√≥n')),
                        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                    );
                });
            }

            mostrarMensaje(texto, tipo) {
                const mensaje = document.getElementById('message');
                mensaje.textContent = texto;
                mensaje.className = `message show ${tipo}`;
                
                if (tipo !== 'loading') {
                    setTimeout(() => {
                        mensaje.classList.remove('show');
                    }, 3000);
                }
            }

            async fetchPOST(data) {
                await fetch(this.SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(data)
                });
            }

            async fetchGET(data) {
                return new Promise((resolve, reject) => {
                    const callback = 'cb' + Date.now();
                    const script = document.createElement('script');
                    const timeout = setTimeout(() => {
                        delete window[callback];
                        script.remove();
                        reject(new Error('Timeout'));
                    }, 15000);

                    window[callback] = (response) => {
                        clearTimeout(timeout);
                        delete window[callback];
                        script.remove();
                        if (response.status === 'success') {
                            resolve(response.data);
                        } else {
                            reject(new Error(response.message));
                        }
                    };

                    const url = new URL(this.SCRIPT_URL);
                    url.searchParams.set('data', JSON.stringify(data));
                    url.searchParams.set('callback', callback);
                    script.src = url.href;
                    script.onerror = () => {
                        clearTimeout(timeout);
                        delete window[callback];
                        script.remove();
                        reject(new Error('Error de red'));
                    };
                    document.body.appendChild(script);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new JornadaSimple();
        });
    </script>
</body>
</html>
