<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Jornada</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#28a745"/>
    <style>:root{--main-bg-color:#f4f7f6;--card-bg-color:#fff;--primary-color:#007bff;--secondary-color:#6c757d;--success-color:#28a745;--danger-color:#dc3545;--text-color:#333;--border-color:#e0e0e0}*{box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;margin:0;padding:10px;background-color:var(--main-bg-color);color:var(--text-color);line-height:1.6}.container{max-width:600px;margin:0 auto}.vista{background:var(--card-bg-color);padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1);margin-bottom:20px}h2{text-align:center;border-bottom:2px solid var(--border-color);padding-bottom:15px;margin-top:0;color:var(--text-color)}button{display:block;width:100%;padding:16px;font-size:18px;font-weight:700;color:#fff;border:none;border-radius:8px;cursor:pointer;margin-top:15px;transition:all .3s ease;text-align:center}button:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15)}button:disabled{opacity:.6;cursor:not-allowed;transform:none}.btn-confirm{background-color:var(--success-color)}.btn-cancel{background-color:var(--danger-color)}label{display:block;margin-bottom:5px;font-weight:700;color:var(--text-color)}input,select{width:100%;padding:14px;margin-bottom:15px;border-radius:8px;border:2px solid var(--border-color);font-size:16px;background-color:#fcfcfc;transition:border-color .3s ease;font-family:inherit;-webkit-appearance:none}input:focus,select:focus{outline:0;border-color:var(--primary-color)}.status-message{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:3000;max-width:90%;width:auto;min-width:320px;text-align:center;font-weight:700;padding:20px 25px;border-radius:12px;box-shadow:0 8px 25px rgba(0,0,0,.3);transition:all .3s ease;backdrop-filter:blur(5px)}.status-success{background-color:rgba(212,237,218,.95);color:#155724;border:2px solid #c3e6cb}.status-error{background-color:rgba(248,215,218,.95);color:#721c24;border:2px solid #f5c6cb}.status-loading{background-color:rgba(209,236,241,.95);color:#0c5460;border:2px solid #bee5eb}.loading-spinner{display:inline-block;width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid #3498db;border-radius:50%;animation:spin 1s linear infinite;margin-right:10px}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.hidden{display:none!important}</style>
</head>
<body>
    <div class="container">
        <div class="vista">
            <h2>‚òÄÔ∏èüåô Registro de Jornada</h2>
            <label for="nombre-usuario">Tu Nombre:</label>
            <select id="nombre-usuario" required><option value="">-- Cargando usuarios... --</option></select>
            <label for="vehiculo">Veh√≠culo:</label>
            <input type="text" id="vehiculo" placeholder="Selecciona tu nombre o escribe" required>
            <label for="kilometraje">Kilometraje:</label>
            <input type="text" inputmode="numeric" pattern="[0-9]*" id="kilometraje" placeholder="Ej: 121205" required>
            <button type="button" id="btn-iniciar-jornada" class="btn-confirm">‚ñ∂Ô∏è Iniciar Jornada y GPS</button>
            <button type="button" id="btn-finalizar-jornada" class="btn-cancel">‚èπÔ∏è Finalizar Jornada y GPS</button>
        </div>
    </div>
    <div class="status-message hidden" id="status-message"></div>
    <script>
        class SistemaJornada {
            constructor() {
                this.SCRIPT_URL = "https.script.google.com/macros/s/AKfycbzTMbUM3OZNnozxj_g8OONJG4zIubpSoHGA59GbliTlUwU0EJAoOSNuyUGhX5FDfsCC/exec";
                this.estado = { procesando: false, idSeguimiento: null, usuarios: [] };
                this.inicializar();
            }

            async inicializar() {
                this.bindearEventos();
                await this.cargarUsuarios();
                this.registrarServiceWorker();
            }

            bindearEventos() {
                document.getElementById('btn-iniciar-jornada').addEventListener('click', () => this.registrarEvento('Inicio de Jornada'));
                document.getElementById('btn-finalizar-jornada').addEventListener('click', () => this.registrarEvento('Fin de Jornada'));
                document.getElementById('nombre-usuario').addEventListener('change', (e) => this.actualizarVehiculo(e.target.value));
            }

            async cargarUsuarios() {
                try {
                    const select = document.getElementById('nombre-usuario');
                    const usuarios = await this.enviarDatosGET({ accion: 'obtener_usuarios' });
                    this.usuarios = usuarios;
                    select.innerHTML = '<option value="">-- Selecciona tu nombre --</option>';
                    usuarios.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.nombre;
                        option.textContent = user.nombre;
                        select.appendChild(option);
                    });
                } catch (error) {
                    this.mostrarMensaje('Error al cargar usuarios', 'error');
                    this.enviarErrorAlServidor(error); // NUEVO: Enviar error al servidor
                }
            }

            actualizarVehiculo(nombreSeleccionado) {
                const vehiculoInput = document.getElementById('vehiculo');
                const usuario = this.usuarios.find(user => user.nombre === nombreSeleccionado);
                vehiculoInput.value = usuario ? usuario.vehiculo : '';
            }

            validarFormulario() {
                const nombre = document.getElementById('nombre-usuario').value;
                const vehiculo = document.getElementById('vehiculo').value.trim();
                const km = document.getElementById('kilometraje').value.trim();
                if (!nombre || !vehiculo || !km) {
                    this.mostrarMensaje('Completa todos los campos', 'error');
                    return null;
                }
                return { nombre, vehiculo, kilometraje: km };
            }

            async registrarEvento(tipoEvento) {
                if (this.estado.procesando) return;
                const datos = this.validarFormulario();
                if (!datos) return;
                this.estado.procesando = true;
                const btn = (tipoEvento === 'Inicio de Jornada') ? document.getElementById('btn-iniciar-jornada') : document.getElementById('btn-finalizar-jornada');
                btn.disabled = true;
                btn.innerHTML = '<span class="loading-spinner"></span>Registrando...';
                this.mostrarMensaje('Obteniendo ubicaci√≥n...', 'loading');
                try {
                    const ubicacion = await this.obtenerUbicacion();
                    const payload = { accion: 'registrar_jornada', tipo_evento: tipoEvento, ubicacion: ubicacion, ...datos };
                    await this.enviarDatosPOST(payload);
                    this.mostrarMensaje(`‚úÖ ${tipoEvento} registrado.`, 'success');
                    document.getElementById('kilometraje').value = '';
                    if (tipoEvento === 'Inicio de Jornada') this.iniciarSeguimiento();
                    else this.detenerSeguimiento();
                } catch (error) {
                    this.mostrarMensaje(`Error: ${error.message}`, 'error');
                    this.enviarErrorAlServidor(error); // NUEVO: Enviar error al servidor
                } finally {
                    setTimeout(() => {
                        this.estado.procesando = false;
                        btn.disabled = false;
                        btn.innerHTML = (tipoEvento === 'Inicio de Jornada') ? '‚ñ∂Ô∏è Iniciar Jornada y GPS' : '‚èπÔ∏è Finalizar Jornada y GPS';
                        this.limpiarMensaje();
                    }, 3000);
                }
            }
            
            iniciarSeguimiento() {
                if (this.estado.idSeguimiento) return;
                this.mostrarMensaje('Seguimiento GPS activado.', 'success');
                this.estado.idSeguimiento = setInterval(() => { this.enviarUbicacion(); }, 60000); // 1 minuto para pruebas
                this.enviarUbicacion();
            }

            detenerSeguimiento() {
                if (this.estado.idSeguimiento) {
                    clearInterval(this.estado.idSeguimiento);
                    this.estado.idSeguimiento = null;
                    this.mostrarMensaje('Seguimiento GPS detenido.', 'success');
                }
            }

            async enviarUbicacion() {
                const usuario = document.getElementById('nombre-usuario').value;
                if (!usuario) return;
                navigator.geolocation.getCurrentPosition(
                    async (pos) => {
                        try {
                            await this.enviarDatosPOST({ accion: 'registrar_gps', usuario: usuario, lat: pos.coords.latitude, lon: pos.coords.longitude });
                            console.log(`Ubicaci√≥n enviada: ${pos.coords.latitude}, ${pos.coords.longitude}`);
                        } catch (error) { this.enviarErrorAlServidor(error); }
                    },
                    (error) => { this.enviarErrorAlServidor(error); },
                    { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
                );
            }

            obtenerUbicacion() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) return reject(new Error("Geolocalizaci√≥n no soportada"));
                    navigator.geolocation.getCurrentPosition(
                        pos => resolve(`${pos.coords.latitude}, ${pos.coords.longitude}`),
                        err => reject(new Error(err.message)),
                        { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
                    );
                });
            }
            
            // NUEVO: Funci√≥n para enviar errores al script
            async enviarErrorAlServidor(error) {
                try {
                    const usuario = document.getElementById('nombre-usuario').value || 'No definido';
                    const payload = {
                        accion: 'registrar_error',
                        usuario: usuario,
                        error: error.message || JSON.stringify(error)
                    };
                    // Usamos fetch directamente aqu√≠ para evitar bucles de errores
                    await fetch(this.SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
                    console.log("Error enviado al servidor.");
                } catch (e) {
                    console.error("Fallo al enviar el error al servidor:", e);
                }
            }

            async enviarDatosPOST(payload) { try { await fetch(this.SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) }); } catch (e) { throw new Error('Error de conexi√≥n.'); } }
            async enviarDatosGET(payload) { return new Promise((resolve, reject) => { const cb = 'c' + Date.now(); const s = document.createElement('script'); const t = setTimeout(() => { delete window[cb]; if (s.parentNode) s.remove(); reject(new Error('Timeout')); }, 20000); window[cb] = (r) => { clearTimeout(t); delete window[cb]; if (s.parentNode) s.remove(); if (r.status === 'success') { resolve(r.data); } else { reject(new Error(r.message)); } }; const u = new URL(this.SCRIPT_URL); u.searchParams.append('data', JSON.stringify(payload)); u.searchParams.append('callback', cb); s.src = u.href; s.onerror = () => { clearTimeout(t); delete window[cb]; if (s.parentNode) s.remove(); reject(new Error('Error de red.')); }; document.body.appendChild(s); }); }
            
            mostrarMensaje(msg, tipo) { const div = document.getElementById('status-message'); div.textContent = msg; div.className = `status-message status-${tipo}`; div.classList.remove('hidden'); }
            limpiarMensaje() { const div = document.getElementById('status-message'); if (div) { div.className = 'status-message hidden'; } }
            
            registrarServiceWorker() { if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js').then(() => console.log('Service Worker Registrado')).catch(error => console.error('Error al registrar SW:', error)); } }
        }
        document.addEventListener('DOMContentLoaded', () => { new SistemaJornada(); });
    </script>
</body>
</html>
