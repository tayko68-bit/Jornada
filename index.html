<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Jornada</title>
    <base href="/Jornada/">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#28a745"/>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="JornadaGPS">
    <style>
        /* ... mismo CSS que antes ... */
        .config-panel{
            background:var(--card-bg-color);
            padding:15px;
            border-radius:8px;
            margin-bottom:15px;
            border:1px solid var(--border-color)
        }
        .config-row{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:10px
        }
        .switch{
            position:relative;
            display:inline-block;
            width:50px;
            height:24px
        }
        .switch input{
            opacity:0;
            width:0;
            height:0
        }
        .slider{
            position:absolute;
            cursor:pointer;
            top:0;
            left:0;
            right:0;
            bottom:0;
            background-color:#ccc;
            transition:.4s;
            border-radius:24px
        }
        .slider:before{
            position:absolute;
            content:"";
            height:18px;
            width:18px;
            left:3px;
            bottom:3px;
            background-color:white;
            transition:.4s;
            border-radius:50%
        }
        input:checked + .slider{
            background-color:var(--success-color)
        }
        input:checked + .slider:before{
            transform:translateX(26px)
        }
        .battery-indicator{
            font-size:12px;
            color:var(--secondary-color)
        }
    </style>
</head>
<body>
    <div class="gps-indicator" id="gps-indicator" title="Estado GPS"></div>
    <div class="debug-info" id="debug-info">Esperando...</div>
    
    <div class="container">
        <!-- Panel de configuraci√≥n de bater√≠a -->
        <div class="config-panel">
            <h3>‚öôÔ∏è Configuraci√≥n de Bater√≠a</h3>
            <div class="config-row">
                <span>Intervalo GPS:</span>
                <select id="gps-interval">
                    <option value="30000">30 seg (+ bater√≠a)</option>
                    <option value="60000" selected>1 min (normal)</option>
                    <option value="120000">2 min (- bater√≠a)</option>
                    <option value="300000">5 min (eco)</option>
                </select>
            </div>
            <div class="config-row">
                <span>Modo supervivencia agresivo:</span>
                <label class="switch">
                    <input type="checkbox" id="modo-agresivo">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="config-row">
                <span>Wake Lock (pantalla):</span>
                <label class="switch">
                    <input type="checkbox" id="wake-lock-enable">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="battery-indicator" id="battery-status">
                Consumo estimado: Medio
            </div>
        </div>

        <div class="vista">
            <h2>‚òÄÔ∏èüåô Registro de Jornada</h2>
            <label for="nombre-usuario">Tu Nombre:</label>
            <select id="nombre-usuario" required>
                <option value="">-- Cargando usuarios... --</option>
            </select>
            <label for="vehiculo">Veh√≠culo:</label>
            <input type="text" id="vehiculo" placeholder="Selecciona tu nombre o escribe" required>
            <label for="kilometraje">Kilometraje:</label>
            <input type="text" inputmode="numeric" pattern="[0-9]*" id="kilometraje" placeholder="Ej: 121205" required>
            <button type="button" id="btn-iniciar-jornada" class="btn-confirm" disabled>‚ñ∂Ô∏è Iniciar Jornada y GPS</button>
            <button type="button" id="btn-finalizar-jornada" class="btn-cancel" disabled>‚èπÔ∏è Finalizar Jornada y GPS</button>
        </div>
    </div>
    <div class="status-message hidden" id="status-message"></div>
    
    <script>
        class SistemaJornada {
            constructor() {
                this.SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzTMbUM3OZNnozxj_g8OONJG4zIubpSoHGA59GbliTlUwU0EJAoOSNuyUGhX5FDfsCC/exec";
                this.configuracion = {
                    intervaloGPS: 60000,
                    modoAgresivo: false,
                    wakeLockHabilitado: false,
                    nivelBateria: 100
                };
                this.estado = { 
                    procesando: false, 
                    usuarios: [], 
                    serviceWorkerReady: false, 
                    gpsActivo: false,
                    wakeLock: null,
                    heartbeatInterval: null,
                    gpsInterval: null,
                    keepAliveInterval: null,
                    ubicacionesProcesadas: 0,
                    ultimaUbicacion: null,
                    modoSegundoPlano: false,
                    consumoBateria: 'medio'
                };
                this.inicializar();
            }

            async inicializar() {
                this.actualizarDebugInfo("Inicializando sistema optimizado...");
                this.configurarPanelBateria();
                this.monitorearBateria();
                this.bindearEventos();
                await this.cargarUsuarios();
                this.registrarServiceWorker();
                this.configurarEscuchaServiceWorker();
                this.configurarIndicadorGPS();
                this.configurarDeteccionSegundoPlano();
                this.actualizarDebugInfo("Sistema listo - Modo ECO");
            }

            // NUEVA: Panel de configuraci√≥n de bater√≠a
            configurarPanelBateria() {
                document.getElementById('gps-interval').addEventListener('change', (e) => {
                    this.configuracion.intervaloGPS = parseInt(e.target.value);
                    this.actualizarEstimacionBateria();
                    this.actualizarDebugInfo(`Intervalo GPS: ${this.configuracion.intervaloGPS/1000}s`);
                    
                    // Si GPS est√° activo, reiniciar con nuevo intervalo
                    if (this.estado.gpsActivo) {
                        this.reiniciarGPS();
                    }
                });

                document.getElementById('modo-agresivo').addEventListener('change', (e) => {
                    this.configuracion.modoAgresivo = e.target.checked;
                    this.actualizarEstimacionBateria();
                    this.actualizarDebugInfo(`Modo agresivo: ${this.configuracion.modoAgresivo ? 'ON' : 'OFF'}`);
                });

                document.getElementById('wake-lock-enable').addEventListener('change', (e) => {
                    this.configuracion.wakeLockHabilitado = e.target.checked;
                    this.actualizarEstimacionBateria();
                    
                    if (!e.target.checked && this.estado.wakeLock) {
                        this.estado.wakeLock.release();
                        this.estado.wakeLock = null;
                        this.actualizarDebugInfo("Wake Lock desactivado por usuario");
                    } else if (e.target.checked && this.estado.gpsActivo) {
                        this.asegurarWakeLock();
                    }
                });
            }

            // NUEVA: Monitoreo de bater√≠a
            async monitorearBateria() {
                if ('getBattery' in navigator) {
                    try {
                        const battery = await navigator.getBattery();
                        this.configuracion.nivelBateria = Math.round(battery.level * 100);
                        
                        const actualizarBateria = () => {
                            this.configuracion.nivelBateria = Math.round(battery.level * 100);
                            this.ajustarComportamientoPorBateria();
                            this.actualizarEstimacionBateria();
                        };

                        battery.addEventListener('levelchange', actualizarBateria);
                        battery.addEventListener('chargingchange', actualizarBateria);
                        
                        this.actualizarDebugInfo(`Bater√≠a: ${this.configuracion.nivelBateria}%`);
                    } catch (error) {
                        this.actualizarDebugInfo("Monitoreo de bater√≠a no disponible");
                    }
                }
            }

            // NUEVA: Ajustar comportamiento seg√∫n bater√≠a
            ajustarComportamientoPorBateria() {
                if (this.configuracion.nivelBateria < 20) {
                    // Bater√≠a baja: modo ultra eco
                    this.configuracion.intervaloGPS = Math.max(this.configuracion.intervaloGPS, 300000); // M√≠n 5 min
                    this.configuracion.modoAgresivo = false;
                    this.configuracion.wakeLockHabilitado = false;
                    
                    document.getElementById('gps-interval').value = '300000';
                    document.getElementById('modo-agresivo').checked = false;
                    document.getElementById('wake-lock-enable').checked = false;
                    
                    this.actualizarDebugInfo("üîã BATER√çA BAJA - Modo ultra ECO activado");
                    this.mostrarMensaje('üîã Bater√≠a baja: activado modo ECO', 'error');
                    
                    if (this.estado.gpsActivo) {
                        this.reiniciarGPS();
                    }
                } else if (this.configuracion.nivelBateria < 50) {
                    // Bater√≠a media: modo moderado
                    if (this.configuracion.intervaloGPS < 60000) {
                        this.configuracion.intervaloGPS = 60000;
                        document.getElementById('gps-interval').value = '60000';
                        this.actualizarDebugInfo("üîã Bater√≠a media - Ajustado a 1 min");
                    }
                }
            }

            // NUEVA: Actualizar estimaci√≥n de consumo
            actualizarEstimacionBateria() {
                let consumo = 0;
                
                // Consumo base del GPS
                if (this.configuracion.intervaloGPS <= 30000) consumo += 4;
                else if (this.configuracion.intervaloGPS <= 60000) consumo += 3;
                else if (this.configuracion.intervaloGPS <= 120000) consumo += 2;
                else consumo += 1;
                
                // Consumo del modo agresivo
                if (this.configuracion.modoAgresivo) consumo += 2;
                
                // Consumo del Wake Lock
                if (this.configuracion.wakeLockHabilitado) consumo += 1;
                
                let nivel, color;
                if (consumo <= 2) {
                    nivel = 'Bajo';
                    color = '#28a745';
                } else if (consumo <= 4) {
                    nivel = 'Medio';
                    color = '#ffc107';
                } else {
                    nivel = 'Alto';
                    color = '#dc3545';
                }
                
                this.estado.consumoBateria = nivel.toLowerCase();
                const batteryStatus = document.getElementById('battery-status');
                batteryStatus.innerHTML = `Consumo estimado: <span style="color:${color}">${nivel}</span> | Bater√≠a: ${this.configuracion.nivelBateria}%`;
            }

            actualizarDebugInfo(mensaje) {
                const debugDiv = document.getElementById('debug-info');
                const timestamp = new Date().toLocaleTimeString();
                debugDiv.innerHTML += `<div>${timestamp}: ${mensaje}</div>`;
                debugDiv.scrollTop = debugDiv.scrollHeight;
                console.log(`[DEBUG] ${mensaje}`);
            }

            // VERSI√ìN OPTIMIZADA: Detecci√≥n de segundo plano
            configurarDeteccionSegundoPlano() {
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && this.estado.gpsActivo) {
                        this.actualizarDebugInfo("üôà P√ÅGINA OCULTA");
                        this.estado.modoSegundoPlano = true;
                        if (this.configuracion.modoAgresivo) {
                            this.activarModoSupervivencia();
                        } else {
                            this.activarModoEco();
                        }
                    } else if (!document.hidden && this.estado.gpsActivo) {
                        this.actualizarDebugInfo("üëÅÔ∏è P√ÅGINA VISIBLE");
                        this.estado.modoSegundoPlano = false;
                        this.desactivarModoSupervivencia();
                    }
                });
            }

            // NUEVA: Modo ECO para segundo plano
            activarModoEco() {
                this.actualizarDebugInfo("üå± Modo ECO activado");
                
                // Solo mantener lo esencial
                if (!this.estado.gpsInterval) {
                    this.estado.gpsInterval = setInterval(() => {
                        this.procesarGPSDirecto();
                    }, this.configuracion.intervaloGPS);
                }
                
                // Heartbeat menos frecuente
                this.configurarHeartbeat(30000); // Cada 30 segundos
            }

            // VERSI√ìN OPTIMIZADA: Modo supervivencia
            activarModoSupervivencia() {
                this.actualizarDebugInfo("üõ°Ô∏è Modo supervivencia activado");
                
                // 1. GPS directo
                if (!this.estado.gpsInterval) {
                    this.estado.gpsInterval = setInterval(() => {
                        this.procesarGPSDirecto();
                    }, this.configuracion.intervaloGPS);
                }

                // 2. Keep-alive moderado (solo si modo agresivo)
                if (this.configuracion.modoAgresivo) {
                    this.activarKeepAliveModerno();
                }

                // 3. Wake Lock solo si habilitado
                if (this.configuracion.wakeLockHabilitado) {
                    this.asegurarWakeLock();
                }
            }

            // NUEVA: Keep-alive moderno y eficiente
            activarKeepAliveModerno() {
                if (!this.estado.keepAliveInterval) {
                    this.estado.keepAliveInterval = setInterval(() => {
                        // Solo un ping ligero
                        fetch('data:text/plain,ping', { method: 'HEAD' }).catch(() => {});
                        this.actualizarDebugInfo("üíì Keep-alive ECO");
                    }, 60000); // Cada minuto (menos frecuente)
                }
            }

            desactivarModoSupervivencia() {
                if (this.estado.gpsInterval) {
                    clearInterval(this.estado.gpsInterval);
                    this.estado.gpsInterval = null;
                    this.actualizarDebugInfo("üõ°Ô∏è Supervivencia desactivada");
                }
                
                if (this.estado.keepAliveInterval) {
                    clearInterval(this.estado.keepAliveInterval);
                    this.estado.keepAliveInterval = null;
                }
            }

            // VERSI√ìN OPTIMIZADA: GPS directo
            async procesarGPSDirecto() {
                try {
                    this.actualizarDebugInfo("üìç GPS DIRECTO...");
                    const ubicacionTexto = await this.obtenerUbicacion();
                    const [lat, lon] = ubicacionTexto.split(', ').map(s => parseFloat(s.trim()));
                    
                    await fetch(this.SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            accion: 'registrar_gps',
                            usuario: document.getElementById('nombre-usuario').value,
                            lat: lat,
                            lon: lon,
                            timestamp: Date.now(),
                            modo: this.configuracion.modoAgresivo ? 'agresivo' : 'eco',
                            segundo_plano: this.estado.modoSegundoPlano,
                            bateria: this.configuracion.nivelBateria
                        })
                    });
                    
                    this.estado.ubicacionesProcesadas++;
                    this.actualizarDebugInfo(`‚úÖ GPS #${this.estado.ubicacionesProcesadas} enviado`);
                    this.actualizarIndicadorGPS(true);
                    
                } catch (error) {
                    this.actualizarDebugInfo(`‚ùå GPS fall√≥: ${error.message}`);
                }
            }

            // NUEVA: Reiniciar GPS con nueva configuraci√≥n
            reiniciarGPS() {
                if (this.estado.gpsActivo) {
                    this.actualizarDebugInfo("üîÑ Reiniciando GPS con nueva configuraci√≥n...");
                    
                    // Detener intervalos actuales
                    if (this.estado.gpsInterval) {
                        clearInterval(this.estado.gpsInterval);
                        this.estado.gpsInterval = null;
                    }
                    
                    // Reiniciar Service Worker
                    if (navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({
                            action: 'stopGps'
                        });
                        
                        setTimeout(() => {
                            navigator.serviceWorker.controller.postMessage({
                                action: 'startGps',
                                usuario: document.getElementById('nombre-usuario').value,
                                url: this.SCRIPT_URL,
                                intervalo: this.configuracion.intervaloGPS
                            });
                        }, 1000);
                    }
                    
                    // Reiniciar modo segundo plano si est√° activo
                    if (this.estado.modoSegundoPlano) {
                        if (this.configuracion.modoAgresivo) {
                            this.activarModoSupervivencia();
                        } else {
                            this.activarModoEco();
                        }
                    }
                }
            }

            async asegurarWakeLock() {
                if ('wakeLock' in navigator && this.configuracion.wakeLockHabilitado && !this.estado.wakeLock) {
                    try {
                        this.estado.wakeLock = await navigator.wakeLock.request('screen');
                        this.actualizarDebugInfo("üîí Wake Lock activado");
                    } catch (error) {
                        this.actualizarDebugInfo("‚ùå Wake Lock fall√≥");
                    }
                }
            }

            configurarHeartbeat(intervalo = 15000) {
                if (this.estado.heartbeatInterval) {
                    clearInterval(this.estado.heartbeatInterval);
                }
                
                this.estado.heartbeatInterval = setInterval(() => {
                    if (this.estado.gpsActivo && navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({
                            action: 'heartbeat',
                            timestamp: Date.now(),
                            configuracion: this.configuracion,
                            bateria: this.configuracion.nivelBateria
                        });
                    }
                }, intervalo);
            }

            // ... resto de m√©todos igual que antes pero optimizados ...

            configurarIndicadorGPS() {
                const indicator = document.getElementById('gps-indicator');
                indicator.addEventListener('click', () => {
                    if (this.estado.gpsActivo) {
                        this.mostrarMensaje(`GPS activo - ${this.estado.ubicacionesProcesadas} ubicaciones | Consumo: ${this.estado.consumoBateria}`, 'success');
                    } else {
                        this.mostrarMensaje('GPS inactivo', 'error');
                    }
                });
            }

            bindearEventos() {
                document.getElementById('btn-iniciar-jornada').addEventListener('click', () => this.registrarEvento('Inicio de Jornada'));
                document.getElementById('btn-finalizar-jornada').addEventListener('click', () => this.registrarEvento('Fin de Jornada'));
                document.getElementById('nombre-usuario').addEventListener('change', (e) => this.actualizarVehiculo(e.target.value));
            }

            configurarEscuchaServiceWorker() {
                if (this.serviceWorkerMessageHandler) {
                    navigator.serviceWorker.removeEventListener('message', this.serviceWorkerMessageHandler);
                }

                this.serviceWorkerMessageHandler = (event) => {
                    if (event.data.action === 'requestLocation') {
                        this.obtenerUbicacionParaSW();
                    } else if (event.data.action === 'gpsStatus') {
                        this.actualizarIndicadorGPS(event.data.active);
                        if (event.data.lastSent) {
                            this.estado.ubicacionesProcesadas++;
                            this.actualizarDebugInfo(`SW: Ubicaci√≥n ${this.estado.ubicacionesProcesadas} enviada`);
                        }
                    } else if (event.data.action === 'ping') {
                        navigator.serviceWorker.controller?.postMessage({
                            action: 'pong',
                            timestamp: Date.now()
                        });
                    }
                };

                navigator.serviceWorker.addEventListener('message', this.serviceWorkerMessageHandler);
            }

            actualizarIndicadorGPS(activo) {
                const indicator = document.getElementById('gps-indicator');
                if (activo) {
                    indicator.classList.add('gps-active');
                    indicator.title = `GPS Activo - ${this.estado.ubicacionesProcesadas} enviadas | ${this.estado.consumoBateria} consumo`;
                } else {
                    indicator.classList.remove('gps-active');
                    indicator.title = 'GPS Inactivo';
                }
            }

            async obtenerUbicacionParaSW() {
                try {
                    const ubicacionTexto = await this.obtenerUbicacion();
                    const [lat, lon] = ubicacionTexto.split(', ').map(s => parseFloat(s.trim()));
                    
                    this.estado.ultimaUbicacion = { lat, lon, timestamp: Date.now() };
                    
                    if (!navigator.serviceWorker.controller) {
                        this.procesarGPSDirecto();
                        return;
                    }
                    
                    navigator.serviceWorker.controller.postMessage({
                        action: 'locationResponse',
                        lat: lat,
                        lon: lon,
                        timestamp: Date.now()
                    });
                    
                } catch (error) {
                    this.actualizarDebugInfo(`‚ùå Error GPS: ${error.message}`);
                    navigator.serviceWorker.controller?.postMessage({
                        action: 'locationError',
                        error: error.message
                    });
                }
            }

            // ... resto de m√©todos igual que antes ...

            async cargarUsuarios() {
                try {
                    const select = document.getElementById('nombre-usuario');
                    const usuarios = await this.enviarDatosGET({ accion: 'obtener_usuarios' });
                    this.usuarios = usuarios;
                    select.innerHTML = '<option value="">-- Selecciona tu nombre --</option>';
                    usuarios.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.nombre;
                        option.textContent = user.nombre;
                        select.appendChild(option);
                    });
                    this.actualizarDebugInfo(`${usuarios.length} usuarios cargados`);
                } catch (error) { 
                    this.mostrarMensaje('Error al cargar usuarios', 'error'); 
                    this.enviarErrorAlServidor(error); 
                }
            }

            actualizarVehiculo(nombreSeleccionado) {
                const vehiculoInput = document.getElementById('vehiculo');
                const usuario = this.usuarios.find(user => user.nombre === nombreSeleccionado);
                vehiculoInput.value = usuario ? usuario.vehiculo : '';
            }

            validarFormulario() {
                const nombre = document.getElementById('nombre-usuario').value;
                const vehiculo = document.getElementById('vehiculo').value.trim();
                const km = document.getElementById('kilometraje').value.trim();
                if (!nombre || !vehiculo || !km) {
                    this.mostrarMensaje('Completa todos los campos', 'error');
                    return null;
                }
                return { nombre, vehiculo, kilometraje: km };
            }

            async registrarEvento(tipoEvento) {
                if (this.estado.procesando) return;
                if (!this.estado.serviceWorkerReady) {
                    this.mostrarMensaje('La app no est√° lista. Por favor, recarga la p√°gina.', 'error');
                    return;
                }
                const datos = this.validarFormulario();
                if (!datos) return;
                
                this.estado.procesando = true;
                const btn = (tipoEvento === 'Inicio de Jornada') ? 
                    document.getElementById('btn-iniciar-jornada') : 
                    document.getElementById('btn-finalizar-jornada');
                btn.disabled = true;
                this.mostrarMensaje('Obteniendo ubicaci√≥n...', 'loading');
                
                try {
                    const ubicacion = await this.obtenerUbicacion();
                    const payload = { 
                        accion: 'registrar_jornada', 
                        tipo_evento: tipoEvento, 
                        ubicacion: ubicacion, 
                        ...datos 
                    };
                    await this.enviarDatosPOST(payload);
                    this.mostrarMensaje(`‚úÖ ${tipoEvento} registrado.`, 'success');
                    document.getElementById('kilometraje').value = '';
                    
                    if (tipoEvento === 'Inicio de Jornada') {
                        this.iniciarSeguimiento();
                    } else {
                        this.detenerSeguimiento();
                    }
                } catch (error) {
                    this.mostrarMensaje(`Error: ${error.message}`, 'error');
                    this.enviarErrorAlServidor(error);
                } finally {
                    setTimeout(() => {
                        this.estado.procesando = false;
                        btn.disabled = false;
                        this.limpiarMensaje();
                    }, 3000);
                }
            }
            
            iniciarSeguimiento() {
                this.actualizarDebugInfo("üöÄ Iniciando GPS optimizado...");
                const usuario = document.getElementById('nombre-usuario').value;
                this.estado.gpsActivo = true;
                this.estado.ubicacionesProcesadas = 0;
                
                this.configurarHeartbeat();
                this.actualizarEstimacionBateria();
                
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        action: 'startGps',
                        usuario: usuario,
                        url: this.SCRIPT_URL,
                        intervalo: this.configuracion.intervaloGPS
                    });
                }
                
                this.actualizarIndicadorGPS(true);
                this.mostrarMensaje(`üõ∞Ô∏è GPS activado - Modo ${this.estado.consumoBateria} consumo`, 'success');
                this.actualizarDebugInfo(`‚úÖ GPS activado - ${this.configuracion.intervaloGPS/1000}s intervalo`);
            }

            detenerSeguimiento() {
                this.actualizarDebugInfo("üõë Deteniendo GPS...");
                this.estado.gpsActivo = false;
                
                this.desactivarModoSupervivencia();
                
                if (this.estado.wakeLock) {
                    this.estado.wakeLock.release();
                    this.estado.wakeLock = null;
                }
                
                if (this.estado.heartbeatInterval) {
                    clearInterval(this.estado.heartbeatInterval);
                    this.estado.heartbeatInterval = null;
                }
                
                navigator.serviceWorker.controller?.postMessage({ action: 'stopGps' });
                this.actualizarIndicadorGPS(false);
                this.mostrarMensaje('‚èπÔ∏è GPS detenido', 'success');
                this.actualizarDebugInfo("‚úÖ GPS detenido");
            }
            
            registrarServiceWorker() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/Jornada/sw.js', {
                        scope: '/Jornada/'
                    })
                        .then((registration) => {
                            this.actualizarDebugInfo("SW registrado");
                            return navigator.serviceWorker.ready;
                        })
                        .then(() => {
                            if (navigator.serviceWorker.controller) {
                                this.actualizarDebugInfo("SW controlando p√°gina");
                                this.estado.serviceWorkerReady = true;
                                document.getElementById('btn-iniciar-jornada').disabled = false;
                                document.getElementById('btn-finalizar-jornada').disabled = false;
                            } else {
                                this.actualizarDebugInfo("SW no activo, recargando...");
                                window.location.reload();
                            }
                        })
                        .catch(error => {
                            this.actualizarDebugInfo("Error SW: " + error.message);
                            this.mostrarMensaje('Error cr√≠tico: No se pudo activar el servicio de fondo.', 'error');
                            this.enviarErrorAlServidor(error);
                        });
                } else {
                    this.mostrarMensaje('El seguimiento en segundo plano no es compatible.', 'error');
                }
            }
            
            obtenerUbicacion() { 
                return new Promise((resolve, reject) => { 
                    if (!navigator.geolocation) return reject(new Error("Geolocalizaci√≥n no soportada")); 
                    navigator.geolocation.getCurrentPosition( 
                        pos => resolve(`${pos.coords.latitude}, ${pos.coords.longitude}`), 
                        err => reject(new Error(err.message)), 
                        { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
                    ); 
                }); 
            }
            
            async enviarErrorAlServidor(error) { 
                try { 
                    const usuario = document.getElementById('nombre-usuario').value || 'No definido'; 
                    const payload = { 
                        accion: 'registrar_error', 
                        usuario: usuario, 
                        error: error.message || JSON.stringify(error) 
                    }; 
                    await fetch(this.SCRIPT_URL, { 
                        method: 'POST', 
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                        body: JSON.stringify(payload) 
                    }); 
                } catch (e) { 
                    console.error("Fallo al enviar el error:", e); 
                } 
            }
            
            async enviarDatosPOST(payload) { 
                try { 
                    await fetch(this.SCRIPT_URL, { 
                        method: 'POST', 
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                        body: JSON.stringify(payload) 
                    }); 
                } catch (e) { 
                    throw new Error('Error de conexi√≥n.'); 
                } 
            }
            
            async enviarDatosGET(payload) { 
                return new Promise((resolve, reject) => { 
                    const cb = 'c' + Date.now(); 
                    const s = document.createElement('script'); 
                    const t = setTimeout(() => { 
                        delete window[cb]; 
                        if (s.parentNode) s.remove(); 
                        reject(new Error('Timeout')); 
                    }, 20000); 
                    window[cb] = (r) => { 
                        clearTimeout(t); 
                        delete window[cb]; 
                        if (s.parentNode) s.remove(); 
                        if (r.status === 'success') { 
                            resolve(r.data); 
                        } else { 
                            reject(new Error(r.message)); 
                        } 
                    }; 
                    const u = new URL(this.SCRIPT_URL); 
                    u.searchParams.append('data', JSON.stringify(payload)); 
                    u.searchParams.append('callback', cb); 
                    s.src = u.href; 
                    s.onerror = () => { 
                        clearTimeout(t); 
                        delete window[cb]; 
                        if (s.parentNode) s.remove(); 
                        reject(new Error('Error de red.')); 
                    }; 
                    document.body.appendChild(s); 
                }); 
            }
            
            mostrarMensaje(msg, tipo) { 
                const div = document.getElementById('status-message'); 
                div.textContent = msg; 
                div.className = `status-message status-${tipo}`; 
                div.classList.remove('hidden'); 
            }
            
            limpiarMensaje() { 
                const div = document.getElementById('status-message'); 
                if (div) { 
                    div.className = 'status-message hidden'; 
                } 
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => { 
            new SistemaJornada(); 
        });
    </script>
</body>
</html>
