<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Jornada</title>
    <base href="/Jornada/">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#28a745"/>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="JornadaGPS">
    <style>
        :root{
            --main-bg-color:#f4f7f6;
            --card-bg-color:#fff;
            --primary-color:#007bff;
            --secondary-color:#6c757d;
            --success-color:#28a745;
            --danger-color:#dc3545;
            --text-color:#333;
            --border-color:#e0e0e0
        }
        *{box-sizing:border-box}
        body{
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
            margin:0;
            padding:10px;
            background-color:var(--main-bg-color);
            color:var(--text-color);
            line-height:1.6
        }
        .container{max-width:600px;margin:0 auto}
        .vista{
            background:var(--card-bg-color);
            padding:20px;
            border-radius:12px;
            box-shadow:0 4px 12px rgba(0,0,0,.1);
            margin-bottom:20px
        }
        h2{
            text-align:center;
            border-bottom:2px solid var(--border-color);
            padding-bottom:15px;
            margin-top:0;
            color:var(--text-color)
        }
        button{
            display:block;
            width:100%;
            padding:16px;
            font-size:18px;
            font-weight:700;
            color:#fff;
            border:none;
            border-radius:8px;
            cursor:pointer;
            margin-top:15px;
            transition:all .3s ease;
            text-align:center
        }
        button:hover:not(:disabled){
            transform:translateY(-2px);
            box-shadow:0 4px 8px rgba(0,0,0,.15)
        }
        button:disabled{
            opacity:.6;
            cursor:not-allowed;
            transform:none
        }
        .btn-confirm{background-color:var(--success-color)}
        .btn-cancel{background-color:var(--danger-color)}
        label{
            display:block;
            margin-bottom:5px;
            font-weight:700;
            color:var(--text-color)
        }
        input,select{
            width:100%;
            padding:14px;
            margin-bottom:15px;
            border-radius:8px;
            border:2px solid var(--border-color);
            font-size:16px;
            background-color:#fcfcfc;
            transition:border-color .3s ease;
            font-family:inherit;
            -webkit-appearance:none
        }
        input:focus,select:focus{
            outline:0;
            border-color:var(--primary-color)
        }
        .status-message{
            position:fixed;
            top:50%;
            left:50%;
            transform:translate(-50%,-50%);
            z-index:3000;
            max-width:90%;
            width:auto;
            min-width:320px;
            text-align:center;
            font-weight:700;
            padding:20px 25px;
            border-radius:12px;
            box-shadow:0 8px 25px rgba(0,0,0,.3);
            transition:all .3s ease;
            backdrop-filter:blur(5px)
        }
        .status-success{
            background-color:rgba(212,237,218,.95);
            color:#155724;
            border:2px solid #c3e6cb
        }
        .status-error{
            background-color:rgba(248,215,218,.95);
            color:#721c24;
            border:2px solid #f5c6cb
        }
        .status-loading{
            background-color:rgba(209,236,241,.95);
            color:#0c5460;
            border:2px solid #bee5eb
        }
        .gps-indicator{
            position:fixed;
            top:10px;
            right:10px;
            width:20px;
            height:20px;
            border-radius:50%;
            background-color:#dc3545;
            z-index:1000;
            animation:pulse 2s infinite;
            cursor:pointer
        }
        .gps-active{background-color:#28a745}
        .debug-info{
            position:fixed;
            bottom:10px;
            left:10px;
            background:rgba(0,0,0,0.8);
            color:white;
            padding:5px 10px;
            border-radius:5px;
            font-size:12px;
            max-width:300px;
            z-index:2000
        }
        .loading-spinner{
            display:inline-block;
            width:20px;
            height:20px;
            border:3px solid #f3f3f3;
            border-top:3px solid #3498db;
            border-radius:50%;
            animation:spin 1s linear infinite;
            margin-right:10px
        }
        @keyframes spin{
            0%{transform:rotate(0)}
            100%{transform:rotate(360deg)}
        }
        @keyframes pulse{
            0%{opacity:1}
            50%{opacity:0.5}
            100%{opacity:1}
        }
        .hidden{display:none!important}
    </style>
</head>
<body>
    <div class="gps-indicator" id="gps-indicator" title="Estado GPS"></div>
    <div class="debug-info" id="debug-info">Esperando...</div>
    <div class="container">
        <div class="vista">
            <h2>‚òÄÔ∏èüåô Registro de Jornada</h2>
            <label for="nombre-usuario">Tu Nombre:</label>
            <select id="nombre-usuario" required>
                <option value="">-- Cargando usuarios... --</option>
            </select>
            <label for="vehiculo">Veh√≠culo:</label>
            <input type="text" id="vehiculo" placeholder="Selecciona tu nombre o escribe" required>
            <label for="kilometraje">Kilometraje:</label>
            <input type="text" inputmode="numeric" pattern="[0-9]*" id="kilometraje" placeholder="Ej: 121205" required>
            <button type="button" id="btn-iniciar-jornada" class="btn-confirm" disabled>‚ñ∂Ô∏è Iniciar Jornada y GPS</button>
            <button type="button" id="btn-finalizar-jornada" class="btn-cancel" disabled>‚èπÔ∏è Finalizar Jornada y GPS</button>
        </div>
    </div>
    <div class="status-message hidden" id="status-message"></div>
    
    <script>
        class SistemaJornada {
            constructor() {
                this.SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzTMbUM3OZNnozxj_g8OONJG4zIubpSoHGA59GbliTlUwU0EJAoOSNuyUGhX5FDfsCC/exec";
                this.estado = { 
                    procesando: false, 
                    usuarios: [], 
                    serviceWorkerReady: false, 
                    gpsActivo: false,
                    wakeLock: null,
                    heartbeatInterval: null,
                    visibilityChangeHandler: null,
                    ubicacionesProcesadas: 0,
                    ultimaUbicacion: null
                };
                this.inicializar();
            }

            actualizarDebugInfo(mensaje) {
                const debugDiv = document.getElementById('debug-info');
                const timestamp = new Date().toLocaleTimeString();
                debugDiv.innerHTML = `${timestamp}: ${mensaje}<br>Ubicaciones: ${this.estado.ubicacionesProcesadas}`;
                console.log(`[DEBUG] ${mensaje}`);
            }

            async inicializar() {
                this.actualizarDebugInfo("Inicializando sistema...");
                this.bindearEventos();
                await this.cargarUsuarios();
                this.registrarServiceWorker();
                this.configurarEscuchaServiceWorker();
                this.configurarMantenimientoSegundoPlano();
                this.configurarIndicadorGPS();
                this.actualizarDebugInfo("Sistema listo");
            }

            configurarIndicadorGPS() {
                const indicator = document.getElementById('gps-indicator');
                indicator.addEventListener('click', () => {
                    if (this.estado.gpsActivo) {
                        this.mostrarMensaje(`GPS activo - ${this.estado.ubicacionesProcesadas} ubicaciones enviadas`, 'success');
                    } else {
                        this.mostrarMensaje('GPS inactivo', 'error');
                    }
                });
            }

            async configurarMantenimientoSegundoPlano() {
                this.configurarWakeLock();
                this.configurarHeartbeat();
                this.configurarVisibilityHandler();
                this.configurarWebLock();
            }

            async configurarWakeLock() {
                if ('wakeLock' in navigator) {
                    try {
                        document.addEventListener('visibilitychange', async () => {
                            if (this.estado.gpsActivo && document.visibilityState === 'visible' && !this.estado.wakeLock) {
                                try {
                                    this.estado.wakeLock = await navigator.wakeLock.request('screen');
                                    this.actualizarDebugInfo("Wake Lock activado");
                                } catch (err) {
                                    this.actualizarDebugInfo("Wake Lock fall√≥");
                                }
                            }
                        });
                    } catch (err) {
                        this.actualizarDebugInfo("Wake Lock no disponible");
                    }
                }
            }

            configurarHeartbeat() {
                this.estado.heartbeatInterval = setInterval(() => {
                    if (this.estado.gpsActivo && navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({
                            action: 'heartbeat',
                            timestamp: Date.now()
                        });
                        this.actualizarDebugInfo("Heartbeat enviado");
                    }
                }, 15000); // Cada 15 segundos
            }

            configurarVisibilityHandler() {
                this.estado.visibilityChangeHandler = () => {
                    if (this.estado.gpsActivo) {
                        if (document.hidden) {
                            this.actualizarDebugInfo("P√°gina oculta");
                            navigator.serviceWorker.controller?.postMessage({
                                action: 'pageHidden'
                            });
                        } else {
                            this.actualizarDebugInfo("P√°gina visible");
                            navigator.serviceWorker.controller?.postMessage({
                                action: 'pageVisible'
                            });
                        }
                    }
                };
                document.addEventListener('visibilitychange', this.estado.visibilityChangeHandler);
            }

            async configurarWebLock() {
                if ('locks' in navigator) {
                    const manteneerLock = async () => {
                        if (this.estado.gpsActivo) {
                            try {
                                await navigator.locks.request('gps-tracking', { mode: 'exclusive' }, async (lock) => {
                                    this.actualizarDebugInfo("Web Lock adquirido");
                                    while (this.estado.gpsActivo) {
                                        await new Promise(resolve => setTimeout(resolve, 5000));
                                    }
                                    this.actualizarDebugInfo("Web Lock liberado");
                                });
                            } catch (err) {
                                this.actualizarDebugInfo("Error con Web Lock");
                            }
                        }
                    };
                    document.addEventListener('gps-started', manteneerLock);
                }
            }

            bindearEventos() {
                document.getElementById('btn-iniciar-jornada').addEventListener('click', () => this.registrarEvento('Inicio de Jornada'));
                document.getElementById('btn-finalizar-jornada').addEventListener('click', () => this.registrarEvento('Fin de Jornada'));
                document.getElementById('nombre-usuario').addEventListener('change', (e) => this.actualizarVehiculo(e.target.value));
            }

            configurarEscuchaServiceWorker() {
                // Eliminar listeners anteriores si existen
                if (this.serviceWorkerMessageHandler) {
                    navigator.serviceWorker.removeEventListener('message', this.serviceWorkerMessageHandler);
                }

                this.serviceWorkerMessageHandler = (event) => {
                    this.actualizarDebugInfo(`SW dice: ${event.data.action}`);
                    
                    if (event.data.action === 'requestLocation') {
                        this.actualizarDebugInfo("SW solicita ubicaci√≥n");
                        this.obtenerUbicacionParaSW();
                    } else if (event.data.action === 'gpsStatus') {
                        this.actualizarIndicadorGPS(event.data.active);
                        if (event.data.lastSent) {
                            this.estado.ubicacionesProcesadas++;
                            this.actualizarDebugInfo(`Ubicaci√≥n ${this.estado.ubicacionesProcesadas} enviada`);
                        }
                    } else if (event.data.action === 'ping') {
                        // Responder inmediatamente al ping del SW
                        navigator.serviceWorker.controller?.postMessage({
                            action: 'pong',
                            timestamp: Date.now()
                        });
                        this.actualizarDebugInfo("Ping respondido");
                    }
                };

                navigator.serviceWorker.addEventListener('message', this.serviceWorkerMessageHandler);
            }

            actualizarIndicadorGPS(activo) {
                const indicator = document.getElementById('gps-indicator');
                if (activo) {
                    indicator.classList.add('gps-active');
                    indicator.title = `GPS Activo - ${this.estado.ubicacionesProcesadas} enviadas`;
                } else {
                    indicator.classList.remove('gps-active');
                    indicator.title = 'GPS Inactivo';
                }
            }

            async obtenerUbicacionParaSW() {
                try {
                    this.actualizarDebugInfo("Obteniendo GPS...");
                    const ubicacionTexto = await this.obtenerUbicacion();
                    const [lat, lon] = ubicacionTexto.split(', ').map(s => parseFloat(s.trim()));
                    
                    this.estado.ultimaUbicacion = { lat, lon, timestamp: Date.now() };
                    this.actualizarDebugInfo(`GPS: ${lat.toFixed(4)}, ${lon.toFixed(4)}`);
                    
                    // Verificar que el SW sigue disponible
                    if (!navigator.serviceWorker.controller) {
                        this.actualizarDebugInfo("ERROR: SW perdido");
                        return;
                    }
                    
                    navigator.serviceWorker.controller.postMessage({
                        action: 'locationResponse',
                        lat: lat,
                        lon: lon,
                        timestamp: Date.now()
                    });
                    
                    this.actualizarDebugInfo("Ubicaci√≥n enviada al SW");
                    
                } catch (error) {
                    this.actualizarDebugInfo(`Error GPS: ${error.message}`);
                    navigator.serviceWorker.controller?.postMessage({
                        action: 'locationError',
                        error: error.message
                    });
                }
            }

            async cargarUsuarios() {
                try {
                    const select = document.getElementById('nombre-usuario');
                    const usuarios = await this.enviarDatosGET({ accion: 'obtener_usuarios' });
                    this.usuarios = usuarios;
                    select.innerHTML = '<option value="">-- Selecciona tu nombre --</option>';
                    usuarios.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.nombre;
                        option.textContent = user.nombre;
                        select.appendChild(option);
                    });
                    this.actualizarDebugInfo(`${usuarios.length} usuarios cargados`);
                } catch (error) { 
                    this.mostrarMensaje('Error al cargar usuarios', 'error'); 
                    this.enviarErrorAlServidor(error); 
                }
            }

            actualizarVehiculo(nombreSeleccionado) {
                const vehiculoInput = document.getElementById('vehiculo');
                const usuario = this.usuarios.find(user => user.nombre === nombreSeleccionado);
                vehiculoInput.value = usuario ? usuario.vehiculo : '';
            }

            validarFormulario() {
                const nombre = document.getElementById('nombre-usuario').value;
                const vehiculo = document.getElementById('vehiculo').value.trim();
                const km = document.getElementById('kilometraje').value.trim();
                if (!nombre || !vehiculo || !km) {
                    this.mostrarMensaje('Completa todos los campos', 'error');
                    return null;
                }
                return { nombre, vehiculo, kilometraje: km };
            }

            async registrarEvento(tipoEvento) {
                if (this.estado.procesando) return;
                if (!this.estado.serviceWorkerReady) {
                    this.mostrarMensaje('La app no est√° lista. Por favor, recarga la p√°gina.', 'error');
                    return;
                }
                const datos = this.validarFormulario();
                if (!datos) return;
                
                this.estado.procesando = true;
                const btn = (tipoEvento === 'Inicio de Jornada') ? 
                    document.getElementById('btn-iniciar-jornada') : 
                    document.getElementById('btn-finalizar-jornada');
                btn.disabled = true;
                this.mostrarMensaje('Obteniendo ubicaci√≥n...', 'loading');
                
                try {
                    const ubicacion = await this.obtenerUbicacion();
                    const payload = { 
                        accion: 'registrar_jornada', 
                        tipo_evento: tipoEvento, 
                        ubicacion: ubicacion, 
                        ...datos 
                    };
                    await this.enviarDatosPOST(payload);
                    this.mostrarMensaje(`‚úÖ ${tipoEvento} registrado.`, 'success');
                    document.getElementById('kilometraje').value = '';
                    
                    if (tipoEvento === 'Inicio de Jornada') {
                        this.iniciarSeguimiento();
                    } else {
                        this.detenerSeguimiento();
                    }
                } catch (error) {
                    this.mostrarMensaje(`Error: ${error.message}`, 'error');
                    this.enviarErrorAlServidor(error);
                } finally {
                    setTimeout(() => {
                        this.estado.procesando = false;
                        btn.disabled = false;
                        this.limpiarMensaje();
                    }, 3000);
                }
            }
            
            iniciarSeguimiento() {
                this.actualizarDebugInfo("Iniciando GPS tracking...");
                const usuario = document.getElementById('nombre-usuario').value;
                this.estado.gpsActivo = true;
                this.estado.ubicacionesProcesadas = 0;
                
                document.dispatchEvent(new CustomEvent('gps-started'));
                
                // Verificar que el SW est√© disponible
                if (!navigator.serviceWorker.controller) {
                    this.actualizarDebugInfo("ERROR: SW no disponible");
                    this.mostrarMensaje('Error: Service Worker no disponible', 'error');
                    return;
                }
                
                navigator.serviceWorker.controller.postMessage({
                    action: 'startGps',
                    usuario: usuario,
                    url: this.SCRIPT_URL,
                    intervalo: 30000 // 30 segundos para testing, luego cambiar a 60000
                });
                
                this.actualizarIndicadorGPS(true);
                this.mostrarMensaje('üõ∞Ô∏è GPS activado - Funciona en segundo plano', 'success');
                this.actualizarDebugInfo("GPS activado");
            }

            detenerSeguimiento() {
                this.actualizarDebugInfo("Deteniendo GPS...");
                this.estado.gpsActivo = false;
                
                if (this.estado.wakeLock) {
                    this.estado.wakeLock.release();
                    this.estado.wakeLock = null;
                }
                
                navigator.serviceWorker.controller?.postMessage({ action: 'stopGps' });
                this.actualizarIndicadorGPS(false);
                this.mostrarMensaje('‚èπÔ∏è GPS detenido', 'success');
                this.actualizarDebugInfo("GPS detenido");
            }
            
            registrarServiceWorker() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/Jornada/sw.js', {
                        scope: '/Jornada/'
                    })
                        .then((registration) => {
                            this.actualizarDebugInfo("SW registrado");
                            return navigator.serviceWorker.ready;
                        })
                        .then(() => {
                            if (navigator.serviceWorker.controller) {
                                this.actualizarDebugInfo("SW controlando p√°gina");
                                this.estado.serviceWorkerReady = true;
                                document.getElementById('btn-iniciar-jornada').disabled = false;
                                document.getElementById('btn-finalizar-jornada').disabled = false;
                                
                                // Test de comunicaci√≥n
                                navigator.serviceWorker.controller.postMessage({
                                    action: 'test',
                                    timestamp: Date.now()
                                });
                            } else {
                                this.actualizarDebugInfo("SW no activo, recargando...");
                                window.location.reload();
                            }
                        })
                        .catch(error => {
                            this.actualizarDebugInfo("Error SW: " + error.message);
                            this.mostrarMensaje('Error cr√≠tico: No se pudo activar el servicio de fondo.', 'error');
                            this.enviarErrorAlServidor(error);
                        });
                } else {
                    this.mostrarMensaje('El seguimiento en segundo plano no es compatible.', 'error');
                }
            }
            
            obtenerUbicacion() { 
                return new Promise((resolve, reject) => { 
                    if (!navigator.geolocation) return reject(new Error("Geolocalizaci√≥n no soportada")); 
                    navigator.geolocation.getCurrentPosition( 
                        pos => resolve(`${pos.coords.latitude}, ${pos.coords.longitude}`), 
                        err => reject(new Error(err.message)), 
                        { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
                    ); 
                }); 
            }
            
            async enviarErrorAlServidor(error) { 
                try { 
                    const usuario = document.getElementById('nombre-usuario').value || 'No definido'; 
                    const payload = { 
                        accion: 'registrar_error', 
                        usuario: usuario, 
                        error: error.message || JSON.stringify(error) 
                    }; 
                    await fetch(this.SCRIPT_URL, { 
                        method: 'POST', 
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                        body: JSON.stringify(payload) 
                    }); 
                } catch (e) { 
                    console.error("Fallo al enviar el error:", e); 
                } 
            }
            
            async enviarDatosPOST(payload) { 
                try { 
                    await fetch(this.SCRIPT_URL, { 
                        method: 'POST', 
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                        body: JSON.stringify(payload) 
                    }); 
                } catch (e) { 
                    throw new Error('Error de conexi√≥n.'); 
                } 
            }
            
            async enviarDatosGET(payload) { 
                return new Promise((resolve, reject) => { 
                    const cb = 'c' + Date.now(); 
                    const s = document.createElement('script'); 
                    const t = setTimeout(() => { 
                        delete window[cb]; 
                        if (s.parentNode) s.remove(); 
                        reject(new Error('Timeout')); 
                    }, 20000); 
                    window[cb] = (r) => { 
                        clearTimeout(t); 
                        delete window[cb]; 
                        if (s.parentNode) s.remove(); 
                        if (r.status === 'success') { 
                            resolve(r.data); 
                        } else { 
                            reject(new Error(r.message)); 
                        } 
                    }; 
                    const u = new URL(this.SCRIPT_URL); 
                    u.searchParams.append('data', JSON.stringify(payload)); 
                    u.searchParams.append('callback', cb); 
                    s.src = u.href; 
                    s.onerror = () => { 
                        clearTimeout(t); 
                        delete window[cb]; 
                        if (s.parentNode) s.remove(); 
                        reject(new Error('Error de red.')); 
                    }; 
                    document.body.appendChild(s); 
                }); 
            }
            
            mostrarMensaje(msg, tipo) { 
                const div = document.getElementById('status-message'); 
                div.textContent = msg; 
                div.className = `status-message status-${tipo}`; 
                div.classList.remove('hidden'); 
            }
            
            limpiarMensaje() { 
                const div = document.getElementById('status-message'); 
                if (div) { 
                    div.className = 'status-message hidden'; 
                } 
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => { 
            new SistemaJornada(); 
        });
    </script>
</body>
</html>
